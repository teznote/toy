{"pathname":"/post/google-calendar-automatically-copy-events-with-apps-script","cat":"/dev","title":"Apps Script 로 구글 캘린더를 다른 캘린더로 자동 복사","description":"구글 Apps Script 활용하여 구글 캘린더 일정을 자동으로 복사","updated":"2023-06-13","layout":"page","content":"<h2>구글 캘린더를 다른 캘린더로 복사</h2><p>구글 캘린더로 공유 받은 캘린더에 있는 모든 일정을 다른 캘린더로 복사해야 할 일이 있었다.</p><p>일정이 생길 때마다 확인해서 수동으로 복사해주면 되긴 했지만, 일정 변경이나 삭제가 잦을 때는 귀찮기도 해서 자동화 할 수 있는 방법이 없을까 찾아보았다.</p><p>찾아보니, 구글에서 제공하는 다양한 웹 어플리케이션을 자동화 할 수 있는 <a href=\"https://www.google.com/script/start/\">Apps Script</a> 가 있어 이를 사용해보기로 했다. MS 오피스에서 VBA 를 다루는 것과 비슷한 느낌이다.</p><p>결론부터 얘기하자면 뭔가 오류가 많은 것 같아 잘 사용하지는 않을 것 같다. (몰론 본인이 제대로 만들어내지도 못하는 것일 수도 있다.) 스크립트를 수동을 실행하면 잘 작동하는데, 트리거에 등록하여 매시간마다 작동하도록 했더니 경우에 따라 작동하지 않는 케이스도 있었다.</p><h2>프로젝트 설정</h2><p>위에 언급한 Apps Script 링크를 타고, 로그인 후, 새 프로젝트를 선택하면 자동으로 편집기가 열린다. 그곳에 코드를 작성하면 되고, 왼쪽 메뉴를 보면 시계모양의 트리거도 등록하여 정기적으로 실행되도록 할 수 있다.</p><h2>구현 로직</h2><p>원본 캘린더 (이하 SRC) 에 있는 일정들을 사본 캘린더 (이하 TAR) 에 복사해 넣는 것이 핵심이다.</p><p>SRC 에 있는 모든 일정들을 일일이 TAR 에 복사하는 것은 비효율이므로, 캘린더의 상태를 나타내는 <code>nextSyncToken</code> 속성을 읽어, 달라진 일정(삭제되거나 변경되거나 추가된 일정들)만 추려서 업데이트 하도록 했다.</p><p>또한 TAR 의 일정을 직접 수정한 경우에는 D+30 에 해당하는 TAR 일정을 불러와 SRC 와 다르다면 맞춰주거나 삭제하도록 했다.</p><p>아래부터는 구현한 코드다. (더 효율적인 방법을 찾아낼 때마다 업데이트 할 생각이다.)</p><h2>SRC 일정들을 TAR 에 복사</h2><pre><code class=\"language-js\"><div class=\"codeline\"><span class=\"hljs-comment\">// 원본 캘린더에서 변화한 일정만을 찾고, 사본 캘린더에 id가 없다면 삽입, id가 있다면 업데이트</span></div><div class=\"codeline\"><span class=\"hljs-keyword\">var</span> src_id = <span class=\"hljs-string\">&#x27;[원본 캘린더의 ID]&#x27;</span>;  <span class=\"hljs-comment\">// 캘린더 ID 는 구글 캘린더에서 캘린더 선택하면 나오는 하위 메뉴의 &quot;설정 및 공유&quot; 에서 확인 가능</span></div><div class=\"codeline\"><span class=\"hljs-keyword\">var</span> tar_id = <span class=\"hljs-string\">&#x27;[사본 캘린더의 ID]&#x27;</span>;</div><div class=\"codeline\"><span class=\"hljs-keyword\">var</span> token = <span class=\"hljs-title class_\">PropertiesService</span>.<span class=\"hljs-title function_\">getScriptProperties</span>().<span class=\"hljs-title function_\">getProperty</span>(<span class=\"hljs-string\">`<span class=\"hljs-subst\">${src_id}</span>_syncToken`</span>);</div><div class=\"codeline\"> </div><div class=\"codeline\"><span class=\"hljs-keyword\">var</span> srcs;</div><div class=\"codeline\"><span class=\"hljs-keyword\">if</span> (token) {</div><div class=\"codeline\">  srcs = <span class=\"hljs-title class_\">Calendar</span>.<span class=\"hljs-property\">Events</span>.<span class=\"hljs-title function_\">list</span>(src_id, {<span class=\"hljs-string\">&#x27;syncToken&#x27;</span>: token});</div><div class=\"codeline\">} <span class=\"hljs-keyword\">else</span> {</div><div class=\"codeline\">  <span class=\"hljs-keyword\">var</span> d = <span class=\"hljs-keyword\">new</span> <span class=\"hljs-title class_\">Date</span>();</div><div class=\"codeline\">  d.<span class=\"hljs-title function_\">setDate</span>(d.<span class=\"hljs-title function_\">getDate</span>() - <span class=\"hljs-number\">30</span>);</div><div class=\"codeline\">  srcs = <span class=\"hljs-title class_\">Calendar</span>.<span class=\"hljs-property\">Events</span>.<span class=\"hljs-title function_\">list</span>(src_id, {<span class=\"hljs-string\">&#x27;timeMin&#x27;</span>: d.<span class=\"hljs-title function_\">toISOString</span>()});</div><div class=\"codeline\">}</div><div class=\"codeline\"><span class=\"hljs-title class_\">PropertiesService</span>.<span class=\"hljs-title function_\">getScriptProperties</span>().<span class=\"hljs-title function_\">setProperty</span>(<span class=\"hljs-string\">`<span class=\"hljs-subst\">${src_id}</span>_syncToken`</span>, srcs.<span class=\"hljs-property\">nextSyncToken</span>);</div><div class=\"codeline\"> </div><div class=\"codeline\"><span class=\"hljs-keyword\">for</span> (<span class=\"hljs-keyword\">var</span> x <span class=\"hljs-keyword\">of</span> srcs.<span class=\"hljs-property\">items</span>) {</div><div class=\"codeline\">  <span class=\"hljs-keyword\">try</span> {</div><div class=\"codeline\">    <span class=\"hljs-title class_\">Calendar</span>.<span class=\"hljs-property\">Events</span>.<span class=\"hljs-title function_\">insert</span>(x, tar_id);</div><div class=\"codeline\">  } <span class=\"hljs-keyword\">catch</span>(e) {</div><div class=\"codeline\">    <span class=\"hljs-keyword\">delete</span> x.<span class=\"hljs-property\">sequence</span>;</div><div class=\"codeline\">    <span class=\"hljs-title class_\">Calendar</span>.<span class=\"hljs-property\">Events</span>.<span class=\"hljs-title function_\">update</span>(x, tar_id, x.<span class=\"hljs-property\">id</span>);</div><div class=\"codeline\">  }</div><div class=\"codeline\">}</div></code></pre><h2>TAR 의 일정을 SRC 일정에 맞춤</h2><pre><code class=\"language-js\"><div class=\"codeline\"><span class=\"hljs-comment\">// 사본 캘린더에서 D+30일까지의 일정 중, 원본 캘린더에 id가 없다면 삭제, id가 있다면 데이터 일치여부 판단해서 원본에 일치시킴</span></div><div class=\"codeline\"><span class=\"hljs-keyword\">var</span> f = <span class=\"hljs-keyword\">new</span> <span class=\"hljs-title class_\">Date</span>();</div><div class=\"codeline\">f.<span class=\"hljs-title function_\">setDate</span>(f.<span class=\"hljs-title function_\">getDate</span>() + <span class=\"hljs-number\">30</span>);</div><div class=\"codeline\"><span class=\"hljs-keyword\">var</span> tars = <span class=\"hljs-title class_\">Calendar</span>.<span class=\"hljs-property\">Events</span>.<span class=\"hljs-title function_\">list</span>(tar_id, {<span class=\"hljs-string\">&#x27;timeMin&#x27;</span>: <span class=\"hljs-keyword\">new</span> <span class=\"hljs-title class_\">Date</span>().<span class=\"hljs-title function_\">toISOString</span>(), <span class=\"hljs-string\">&#x27;timeMax&#x27;</span>: f.<span class=\"hljs-title function_\">toISOString</span>()});</div><div class=\"codeline\"> </div><div class=\"codeline\"><span class=\"hljs-keyword\">for</span> (<span class=\"hljs-keyword\">var</span> x <span class=\"hljs-keyword\">of</span> tars.<span class=\"hljs-property\">items</span>) {</div><div class=\"codeline\">  <span class=\"hljs-keyword\">try</span> {</div><div class=\"codeline\">    <span class=\"hljs-keyword\">var</span> w = <span class=\"hljs-title class_\">Calendar</span>.<span class=\"hljs-property\">Events</span>.<span class=\"hljs-title function_\">get</span>(src_id, x.<span class=\"hljs-property\">id</span>);</div><div class=\"codeline\">    <span class=\"hljs-keyword\">delete</span> x.<span class=\"hljs-property\">sequence</span>;</div><div class=\"codeline\">    <span class=\"hljs-keyword\">delete</span> w.<span class=\"hljs-property\">sequence</span>;</div><div class=\"codeline\">    <span class=\"hljs-keyword\">if</span> (w !== x) {</div><div class=\"codeline\">      <span class=\"hljs-title class_\">Calendar</span>.<span class=\"hljs-property\">Events</span>.<span class=\"hljs-title function_\">update</span>(w, tar_id, w.<span class=\"hljs-property\">id</span>);</div><div class=\"codeline\">    }</div><div class=\"codeline\">  } <span class=\"hljs-keyword\">catch</span>(e) {</div><div class=\"codeline\">    <span class=\"hljs-title class_\">Calendar</span>.<span class=\"hljs-property\">Events</span>.<span class=\"hljs-title function_\">remove</span>(tar_id, x.<span class=\"hljs-property\">id</span>);</div><div class=\"codeline\">  }</div><div class=\"codeline\">}</div></code></pre>"}
